<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat</title>
</head>
<body>
<form onsubmit="return false;">
    <h3>WebSocket 聊天室：</h3>
    <textarea id="responseText" style="width: 500px; height: 300px;"></textarea>
    <br>
    <input type="text" name="message"  style="width: 300px;" value="xxx" id="content">
    <input type="button" value="发送消息" id="send">
    <input type="button" onclick="javascript:document.getElementById('responseText').value=''" value="清空聊天记录">
</form>
<br>
<br>
<script type="application/javascript">
    // 构建聊天业务CHAT
    function ChatMsg(senderId, receiverId, content, msgId){
        this.senderId = senderId;
        this.receiverId = receiverId;
        this.content = content;
        this.msgId = msgId;
    }

    function DataContent(action, msg, extend) {
        this.action =action;
        this.msg = msg;
        this.extend = extend;
    }

    window.CHAT = {
        socket: null,
        init: function() {
            if (window.WebSocket) {
                CHAT.socket = new WebSocket("ws://localhost:7888/ws");
                CHAT.socket.onopen = CHAT.wsopen;
                CHAT.socket.onclose = CHAT.wsclose;
                CHAT.socket.onerror = CHAT.wserror;
                CHAT.socket.onmessage = CHAT.wsmessage;
            } else {
                alert("手机设备过旧，请升级手机设备...");
            }
        },
        chat: function(msg) {
            CHAT.socket.send(msg);
        },
        reChat: function(msg) {
            console.log("消息重新发送...");
            CHAT.socket.send(msg);
        },
        wsopen: function() {
            console.log("websocket连接已建立...");

            // 构建ChatMsg
            var chatMsg = new ChatMsg(8, null, null, null);
            // 构建DataContent
            var dataContent = new DataContent(1, chatMsg, null);
            console.log(JSON.stringify(dataContent));
            // 发送websocket
            CHAT.chat(JSON.stringify(dataContent));
        },
        wsmessage: function(e) {
            console.log("接受到消息：" + e.data);

            // 转换DataContent为对象
            var dataContent = JSON.parse(e.data);
            var action = dataContent.action;

            // 如果不是重新拉取好友列表，则获取聊天消息模型，渲染接收到的聊天记录
            var chatMsg = dataContent.msg;
            var content = chatMsg.content;
            var friendUserId = chatMsg.senderId;
            var myId = chatMsg.receiverId;

            // 接受到消息之后，对消息记录进行签收
            var dataContentSign = new DataContent(3, null, chatMsg.msgId);
            CHAT.chat(JSON.stringify(dataContentSign));
        },
        wsclose: function() {
            console.log("连接关闭...");
        },
        wserror: function() {
            console.log("发生错误...");
        },
        signMsgList: function(unSignedMsgIds) {
            // 构建批量签收对象的模型
            var dataContentSign = new DataContent(3,
                null,
                unSignedMsgIds);
            // 发送批量签收的请求
            CHAT.chat(JSON.stringify(dataContentSign));
        },
    };

    CHAT.init();
    var btn = document.getElementById("send");
    btn.onclick = function () {
        var content = document.getElementById("content").value;
        console.log(content);
        var msg = new ChatMsg(8,11,content, null);
        var dataContent = new DataContent(2, msg, null);
        console.log(JSON.stringify(dataContent));
        CHAT.chat(JSON.stringify(dataContent));
    }
</script>
</body>
</html>